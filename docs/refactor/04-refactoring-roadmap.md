# 04 â€” é‡æ„è·¯çº¿å›¾

> 5 é˜¶æ®µåˆ†æ­¥å®æ–½è®¡åˆ’ï¼Œä»åŸºç¡€è®¾æ–½åˆ°è´¨é‡ä½“ç³»é€æ­¥æ¼”è¿›ã€‚

---

## 1. æ€»ä½“è·¯çº¿å›¾

```mermaid
gantt
    title iPhoton é‡æ„è·¯çº¿å›¾
    dateFormat  YYYY-MM-DD
    axisFormat  %mæœˆ

    section é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½
    DI å®¹å™¨å¢å¼º           :a1, 2026-02-20, 10d
    EventBus é‡å»º         :a2, after a1, 7d
    è¿æ¥æ± ä¼˜åŒ–            :a3, after a1, 5d
    ç»Ÿä¸€é”™è¯¯å¤„ç†          :a4, after a2, 5d

    section é˜¶æ®µäºŒï¼šé¢†åŸŸä¸åº”ç”¨å±‚
    Legacy Model è¿ç§»     :b1, after a4, 7d
    Use Case è¡¥å…¨         :b2, after b1, 14d
    Service å±‚æ•´åˆ        :b3, after b1, 10d
    Facade ç˜¦èº«          :b4, after b2, 10d

    section é˜¶æ®µä¸‰ï¼šGUI MVVM
    ViewModel æ‹†åˆ†        :c1, after b4, 14d
    Coordinator ç²¾ç®€      :c2, after c1, 10d
    å¤§æ–‡ä»¶æ‹†åˆ†            :c3, after c1, 14d
    Qt Signal â†’ EventBus  :c4, after c2, 10d

    section é˜¶æ®µå››ï¼šæ€§èƒ½ä¼˜åŒ–
    å¹¶è¡Œæ‰«æ              :d1, after c4, 10d
    ä¸‰çº§ç¼©ç•¥å›¾ç¼“å­˜        :d2, after c4, 10d
    å†…å­˜æ²»ç†              :d3, after d1, 7d
    GPU ç®¡çº¿ä¼˜åŒ–          :d4, after d2, 7d

    section é˜¶æ®µäº”ï¼šæµ‹è¯•ä¸ CI/CD
    å•å…ƒæµ‹è¯•è¡¥å…¨          :e1, after b1, 30d
    é›†æˆæµ‹è¯•æ¡†æ¶          :e2, after c4, 14d
    CI/CD æµæ°´çº¿          :e3, after e1, 10d
    è´¨é‡é—¨ç¦              :e4, after e3, 5d

    section é‡Œç¨‹ç¢‘
    Alpha Release         :milestone, after c2, 0d
    Beta Release          :milestone, after d3, 0d
    v3.0 Release          :milestone, after e4, 0d
```

---

## 2. é˜¶æ®µæ¦‚è§ˆ

### 2.1 äº”é˜¶æ®µæ‘˜è¦

| é˜¶æ®µ | åç§° | æ—¶é—´ | æ ¸å¿ƒç›®æ ‡ | é£é™©ç­‰çº§ |
|------|------|------|---------|---------|
| **ä¸€** | [åŸºç¡€è®¾æ–½](./05-phase1-infrastructure.md) | 3-4å‘¨ | DI + EventBus + è¿æ¥æ±  + é”™è¯¯å¤„ç† | ğŸŸ¢ ä½ |
| **äºŒ** | [é¢†åŸŸä¸åº”ç”¨å±‚](./06-phase2-domain-application.md) | 4-5å‘¨ | æ¶ˆé™¤åŒé‡æ¨¡å‹ + Use Case è¡¥å…¨ + Facade ç˜¦èº« | ğŸŸ  ä¸­ |
| **ä¸‰** | [GUI MVVM](./07-phase3-gui-mvvm.md) | 4-5å‘¨ | ViewModel æ‹†åˆ† + å¤§æ–‡ä»¶æ²»ç† + Qt è§£è€¦ | ğŸ”´ é«˜ |
| **å››** | [æ€§èƒ½ä¼˜åŒ–](./08-phase4-performance.md) | 3-4å‘¨ | å¹¶è¡Œæ‰«æ + ä¸‰çº§ç¼“å­˜ + å†…å­˜æ²»ç† | ğŸŸ  ä¸­ |
| **äº”** | [æµ‹è¯•ä¸ CI/CD](./09-phase5-testing-ci.md) | æŒç»­ | æµ‹è¯•è¦†ç›– â‰¥80% + CI æµæ°´çº¿ + è´¨é‡é—¨ç¦ | ğŸŸ¢ ä½ |

### 2.2 ä¾èµ–å…³ç³»

```mermaid
graph LR
    P1["é˜¶æ®µä¸€<br/>åŸºç¡€è®¾æ–½"]
    P2["é˜¶æ®µäºŒ<br/>é¢†åŸŸä¸åº”ç”¨å±‚"]
    P3["é˜¶æ®µä¸‰<br/>GUI MVVM"]
    P4["é˜¶æ®µå››<br/>æ€§èƒ½ä¼˜åŒ–"]
    P5["é˜¶æ®µäº”<br/>æµ‹è¯•ä¸CI/CD"]

    P1 --> P2
    P2 --> P3
    P3 --> P4
    P1 --> P5
    P5 -.->|"æŒç»­è¿›è¡Œ"| P2
    P5 -.->|"æŒç»­è¿›è¡Œ"| P3
    P5 -.->|"æŒç»­è¿›è¡Œ"| P4

    style P1 fill:#339af0,color:#fff
    style P2 fill:#51cf66,color:#fff
    style P3 fill:#fcc419,color:#333
    style P4 fill:#ff922b,color:#fff
    style P5 fill:#845ef7,color:#fff
```

---

## 3. å„é˜¶æ®µå…³é”®é‡Œç¨‹ç¢‘

### 3.1 é˜¶æ®µä¸€å®Œæˆæ ‡å‡†

- [ ] DI å®¹å™¨æ”¯æŒ Singleton/Transient/Scoped ç”Ÿå‘½å‘¨æœŸ
- [ ] DI å®¹å™¨æ”¯æŒå¾ªç¯ä¾èµ–æ£€æµ‹
- [ ] EventBus æ”¯æŒåŒæ­¥/å¼‚æ­¥äº‹ä»¶å‘å¸ƒ
- [ ] EventBus æ”¯æŒäº‹ä»¶è®¢é˜…ä¸å–æ¶ˆ
- [ ] è¿æ¥æ± çº¿ç¨‹å®‰å…¨ä¸”é€šè¿‡å‹åŠ›æµ‹è¯•
- [ ] ç»Ÿä¸€é”™è¯¯å¤„ç†æ¡†æ¶å°±ç»ª
- [ ] æ‰€æœ‰æ–°å¢ä»£ç æµ‹è¯•è¦†ç›– â‰¥90%

### 3.2 é˜¶æ®µäºŒå®Œæˆæ ‡å‡†

- [ ] `models/album.py` å·²åºŸå¼ƒï¼Œæ‰€æœ‰ä»£ç ä½¿ç”¨ `domain/models/`
- [ ] è‡³å°‘ 11 ä¸ª Use Case å·²å®ç°
- [ ] `AppFacade` è¡Œæ•° â‰¤200è¡Œï¼ˆä»734è¡Œå‰Šå‡ï¼‰
- [ ] GUI Services ä¸­çš„ä¸šåŠ¡é€»è¾‘å·²è¿ç§»åˆ° Application Services
- [ ] CLI å’Œ GUI é€šè¿‡åŒä¸€ç»„ Use Case å·¥ä½œ

### 3.3 é˜¶æ®µä¸‰å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ ViewModel ä¸ºçº¯ Python ç±»ï¼ˆæ—  QObject ç»§æ‰¿ï¼‰
- [ ] Coordinator æ•°é‡ â‰¤15ä¸ªï¼Œæ¯ä¸ª â‰¤200è¡Œ
- [ ] æ‰€æœ‰è¶…è¿‡ 300è¡Œçš„æ–‡ä»¶å·²æ‹†åˆ†
- [ ] Qt Signal ä»…ç”¨äº View â†” ViewModel çš„ UI æ›´æ–°
- [ ] è·¨å±‚é€šä¿¡ 100% é€šè¿‡ EventBus

### 3.4 é˜¶æ®µå››å®Œæˆæ ‡å‡†

- [ ] 10K æ–‡ä»¶æ‰«ææ—¶é—´ â‰¤30ç§’
- [ ] UI é˜»å¡æ—¶é—´ â‰¤200ms
- [ ] ç¼©ç•¥å›¾ L1 ç¼“å­˜å‘½ä¸­ç‡ â‰¥70%
- [ ] å†…å­˜å³°å€¼ â‰¤2GB (100K æ–‡ä»¶ç›¸å†Œ)

### 3.5 é˜¶æ®µäº”å®Œæˆæ ‡å‡†

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥80%
- [ ] é›†æˆæµ‹è¯•è¦†ç›–æ‰€æœ‰ Use Case
- [ ] CI æµæ°´çº¿è‡ªåŠ¨è¿è¡Œ lint + test + type check
- [ ] è´¨é‡é—¨ç¦é˜»æ­¢è¦†ç›–ç‡ä¸‹é™çš„ PR

---

## 4. é£é™©ç®¡ç†

### 4.1 é£é™©çŸ©é˜µ

```mermaid
quadrantChart
    title é£é™©è¯„ä¼°çŸ©é˜µ
    x-axis "å‘ç”Ÿæ¦‚ç‡ ä½" --> "å‘ç”Ÿæ¦‚ç‡ é«˜"
    y-axis "å½±å“ç¨‹åº¦ ä½" --> "å½±å“ç¨‹åº¦ é«˜"
    quadrant-1 "é‡ç‚¹ç›‘æ§"
    quadrant-2 "åˆ¶å®šé¢„æ¡ˆ"
    quadrant-3 "å¸¸è§„å¤„ç†"
    quadrant-4 "æŒç»­å…³æ³¨"
    "GUIé‡æ„å¼•å…¥å›å½’": [0.7, 0.85]
    "Facadeè¿ç§»æ•°æ®ä¸¢å¤±": [0.3, 0.9]
    "EventBusæ€§èƒ½ç“¶é¢ˆ": [0.4, 0.5]
    "DIå®¹å™¨å†…å­˜æ³„æ¼": [0.3, 0.6]
    "æµ‹è¯•ç¯å¢ƒå·®å¼‚": [0.6, 0.3]
    "å¹¶è¡Œæ‰«ææ­»é”": [0.5, 0.7]
```

### 4.2 ç¼“è§£ç­–ç•¥

| é£é™© | ç¼“è§£ç­–ç•¥ |
|------|---------|
| GUI é‡æ„å¼•å…¥å›å½’ | Feature Flag é€æ­¥åˆ‡æ¢ï¼›åŒè½¨è¿è¡ŒæœŸä¿ç•™ Legacy è·¯å¾„ |
| Facade è¿ç§»æ•°æ®ä¸¢å¤± | æ•°æ®åº“å¤‡ä»½ç­–ç•¥ï¼›Use Case äº‹åŠ¡æ€§ä¿è¯ |
| EventBus æ€§èƒ½ç“¶é¢ˆ | å‹åŠ›æµ‹è¯•ï¼ˆ10K events/sï¼‰ï¼›æ‰¹é‡äº‹ä»¶åˆå¹¶ |
| å¹¶è¡Œæ‰«ææ­»é” | è¿æ¥æ±  + è¶…æ—¶æœºåˆ¶ï¼›WAL æ¨¡å¼ SQLite |

### 4.3 å›æ»šç­–ç•¥

æ¯ä¸ªé˜¶æ®µè®¾ç½® **Feature Flag**ï¼Œæ”¯æŒå¿«é€Ÿå›æ»šï¼š

```python
# settings/feature_flags.py
class FeatureFlags:
    USE_NEW_DI_CONTAINER = True      # é˜¶æ®µä¸€
    USE_EVENT_BUS = True             # é˜¶æ®µä¸€
    USE_UNIFIED_MODELS = False       # é˜¶æ®µäºŒ
    USE_NEW_FACADE = False           # é˜¶æ®µäºŒ
    USE_MVVM_VIEWMODELS = False      # é˜¶æ®µä¸‰
    USE_PARALLEL_SCAN = False        # é˜¶æ®µå››
    USE_THREE_TIER_CACHE = False     # é˜¶æ®µå››
```

---

## 5. è¿ç§»ç­–ç•¥

### 5.1 å¢é‡è¿ç§»åŸåˆ™

```mermaid
graph TB
    subgraph "è¿ç§»åŸåˆ™"
        P1_2["1. æ–°ä»£ç ç”¨æ–°æ¶æ„"]
        P2_2["2. ä¿®æ”¹æ—§ä»£ç æ—¶é¡ºå¸¦è¿ç§»"]
        P3_2["3. Feature Flag æ§åˆ¶åˆ‡æ¢"]
        P4_2["4. åŒè½¨è¿è¡ŒæœŸä¸è¶…è¿‡2å‘¨"]
        P5_2["5. æ¯ä¸ªPRéƒ½å¿…é¡»é€šè¿‡æµ‹è¯•"]
    end

    P1_2 --> P2_2 --> P3_2 --> P4_2 --> P5_2
```

### 5.2 Facade è¿ç§»è·¯å¾„

```mermaid
stateDiagram-v2
    [*] --> GodFacade: å½“å‰çŠ¶æ€
    GodFacade --> ThinFacade: é˜¶æ®µäºŒï¼šæå– Use Cases
    ThinFacade --> Coordinator: é˜¶æ®µä¸‰ï¼šCoordinator æ¥ç®¡
    Coordinator --> Removed: é˜¶æ®µä¸‰å®Œæˆï¼šFacade åˆ é™¤

    GodFacade: AppFacade (734è¡Œ)\n15+ èŒè´£\nQt Signal è€¦åˆ
    ThinFacade: AppFacade (â‰¤200è¡Œ)\nä»…ä¿¡å·è·¯ç”±\nUse Case å§”æ‰˜
    Coordinator: MainCoordinator\nèŒè´£å•ä¸€\nEventBus é€šä¿¡
    Removed: Facade å·²åˆ é™¤\nèŒè´£å®Œå…¨è¿ç§»
```

---

## 6. éªŒæ”¶æ ‡å‡†æ€»è§ˆ

| ç»´åº¦ | æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|------|
| **æ¶æ„** | God Object æ•°é‡ | 0 |
| **æ¶æ„** | æœ€å¤§æ–‡ä»¶è¡Œæ•° | â‰¤300è¡Œ |
| **æ¶æ„** | Qt æ¸—é€å±‚æ•° | 1å±‚ï¼ˆä»… Viewï¼‰ |
| **è¦†ç›–** | Use Case è¦†ç›–ç‡ | 100% |
| **è¦†ç›–** | DI è¦†ç›–ç‡ | â‰¥95% |
| **è¦†ç›–** | EventBus ä½¿ç”¨ç‡ | 100% |
| **è´¨é‡** | å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | â‰¥80% |
| **è´¨é‡** | é›†æˆæµ‹è¯•è¦†ç›– | æ‰€æœ‰ Use Case |
| **æ€§èƒ½** | æ‰«æé€Ÿåº¦ (10K) | â‰¤30ç§’ |
| **æ€§èƒ½** | UI é˜»å¡ | â‰¤200ms |
| **æ€§èƒ½** | å†…å­˜å³°å€¼ (100K) | â‰¤2GB |
